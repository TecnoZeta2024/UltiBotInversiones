# Story 4.4: Aplicación de Reglas de Gestión de Capital y Salidas Automatizadas a Operaciones Reales

## Status: InProgress

## Story

- Como usuario de UltiBotInversiones,
- quiero que cuando se ejecute una operación con dinero real, el sistema aplique automáticamente mis reglas de gestión de capital (límite de inversión diaria del 50% y ajuste dinámico al 25% basado en riesgo) y también la gestión automatizada de Trailing Stop Loss y Take Profit,
- para proteger mi capital real y asegurar una operativa disciplinada y consistente con mi estrategia.

## Acceptance Criteria (ACs)

AC1: Antes de presentar la propuesta de operación real para confirmación del usuario (Historia 4.3), el sistema debe haber calculado el tamaño de la posición basándose en las reglas de gestión de capital definidas (FR3.1 y FR3.2), aplicadas sobre el capital real disponible en la cuenta de Binance.
AC2: Inmediatamente después de que una operación real sea confirmada por el usuario y la orden de entrada sea aceptada por Binance, el sistema debe calcular y colocar automáticamente en Binance las órdenes correspondientes de Trailing Stop Loss y Take Profit, utilizando la misma lógica y algoritmos diseñados por el equipo BMAD para el paper trading (FRX.1, FRX.2).
AC3: El estado de estas órdenes de TSL y TP reales debe ser visible en la interfaz de usuario, asociado a la posición real abierta.
AC4: La ejecución de un TSL o TP en una operación real debe ser notificada al usuario (UI y Telegram) y debe cerrar la posición correspondiente en Binance.
AC5: El sistema debe monitorear y respetar la regla de no exceder el 50% del capital total disponible para inversión diaria, considerando el capital comprometido en estas operaciones reales.

## Tasks / Subtasks

- [ ] **Subtask 1: Backend - Implementación de Lógica de Gestión de Capital para Operaciones Reales** (AC: 1, 5)
    - [ ] 1.1: En `TradingEngineService`, implementar o adaptar la función de cálculo de tamaño de posición para que use `UserConfiguration.riskProfileSettings` y `UserConfiguration.realTradingSettings` sobre el saldo real de Binance.
    - [ ] 1.2: Asegurar que el cálculo respete el `dailyCapitalRiskPercentage` (50% del capital total disponible) y el `perTradeCapitalRiskPercentage` (ajuste dinámico al 25% basado en riesgo).
    - [ ] 1.3: Implementar un mecanismo en `TradingEngineService` para monitorear el capital total comprometido diariamente en operaciones reales y prevenir nuevas entradas si se excede el límite del 50%.
    - [ ] 1.4: Integrar con `ConfigService` para obtener y actualizar la configuración del usuario relacionada con la gestión de capital.

- [ ] **Subtask 2: Backend - Gestión Automatizada de TSL y TP para Operaciones Reales** (AC: 2, 4)
    - [ ] 2.1: En `TradingEngineService`, adaptar o reutilizar la lógica de cálculo y gestión de Trailing Stop Loss (TSL) y Take Profit (TP) del modo paper trading para aplicarla a operaciones reales.
    - [ ] 2.2: Asegurar que, tras la confirmación y ejecución de la orden de entrada real, se envíen automáticamente las órdenes de TSL y TP a Binance a través de `BinanceAdapter`.
    - [ ] 2.3: Implementar el monitoreo de estas órdenes de TSL/TP en Binance para detectar su ejecución y actualizar el estado del `Trade` correspondiente.
    - [ ] 2.4: En caso de ejecución de TSL o TP, asegurar que se cierre la posición en Binance y se actualice el `Trade` en la base de datos.
    - [ ] 2.5: Integrar con `NotificationService` para enviar notificaciones (UI y Telegram) cuando un TSL o TP real se ejecute.

- [ ] **Subtask 3: Frontend - Visualización de TSL/TP y Estado de Gestión de Capital** (AC: 3)
    - [ ] 3.1: Modificar la UI (ej. en la vista de operaciones abiertas o en el gráfico) para mostrar los niveles activos de TSL y TP para las posiciones reales abiertas.
    - [ ] 3.2: Asegurar que la UI refleje el capital disponible para nuevas operaciones reales, considerando el límite diario del 50% y el capital ya comprometido.
    - [ ] 3.3: Mostrar mensajes claros en la UI si se alcanza el límite de capital diario o si no se pueden abrir nuevas operaciones reales debido a las reglas de gestión de capital.

- [ ] **Subtask 4: Pruebas Unitarias y de Integración**
    - [ ] 4.1: Escribir pruebas unitarias para la lógica de gestión de capital en `TradingEngineService`, incluyendo el cálculo del tamaño de la posición y el monitoreo del límite diario.
    - [ ] 4.2: Escribir pruebas unitarias para la lógica de TSL/TP en `TradingEngineService` para operaciones reales, mockeando `BinanceAdapter` y `NotificationService`.
    - [ ] 4.3: Escribir pruebas de integración para el flujo completo de una operación real, desde la confirmación hasta la gestión de TSL/TP, asegurando que las interacciones con `BinanceAdapter`, `ConfigService`, `DataPersistenceService` y `NotificationService` sean correctas.

## Dev Technical Guidance

### Backend

-   **`TradingEngineService` (`src/ultibot_backend/services/trading_engine_service.py`):**
    -   **Gestión de Capital:**
        -   La lógica de cálculo de `requestedQuantity` debe ser robusta y considerar tanto `UserConfiguration.riskProfileSettings.dailyCapitalRiskPercentage` como `UserConfiguration.realTradingSettings.perTradeCapitalRiskPercentage`.
        -   Implementar un mecanismo para rastrear el capital ya comprometido en operaciones reales abiertas y el capital total arriesgado en el día para hacer cumplir el límite del 50%. Esto podría requerir un campo adicional en `UserConfiguration` o un mecanismo de caché en Redis.
        -   Asegurar que el `TradingEngineService` pueda pausar la apertura de nuevas operaciones reales si se excede el límite diario de capital arriesgado.
    -   **TSL/TP para Real:**
        -   Reutilizar los algoritmos de cálculo de TSL y TP del paper trading. La diferencia principal será la interacción con la API de Binance para colocar y monitorear órdenes reales.
        -   Las órdenes de TSL y TP en Binance pueden ser órdenes `STOP_LOSS_LIMIT` y `TAKE_PROFIT_LIMIT` o `OCO` (One Cancels the Other) si se desea que una cancele la otra automáticamente. Investigar la mejor aproximación para Binance.
        -   El monitoreo de estas órdenes debe ser continuo (ej. a través de WebSockets de usuario o polling periódico) para detectar su ejecución y actualizar el estado del `Trade` en la base de datos.
        -   Manejar los posibles errores de Binance al colocar o monitorear estas órdenes (ej. `INSUFFICIENT_FUNDS` si el capital se mueve, `ORDER_WOULD_TRIGGER_IMMEDIATELY`).
-   **`BinanceAdapter` (`src/ultibot_backend/adapters/binance_adapter.py`):**
    -   Extender el adaptador para soportar la colocación de órdenes `STOP_LOSS_LIMIT`, `TAKE_PROFIT_LIMIT` y `OCO` en Binance.
    -   Implementar métodos para consultar el estado de órdenes específicas (TSL/TP) y para cancelar órdenes si es necesario.
-   **`ConfigService` (`src/ultibot_backend/services/config_service.py`):**
    -   Asegurar que el `TradingEngineService` pueda acceder y actualizar de forma atómica los campos `real_trading_settings.real_trades_executed_count` y cualquier nuevo campo para el seguimiento del capital diario arriesgado en `UserConfiguration`.
-   **`NotificationService` (`src/ultibot_backend/services/notification_service.py`):**
    -   Definir nuevos tipos de eventos de notificación para la ejecución de TSL/TP reales (ej. `REAL_TRADE_TSL_HIT`, `REAL_TRADE_TP_HIT`) y asegurar que se envíen a los canales configurados (UI, Telegram).
-   **Modelos de Datos (`src/shared/data_types.py`):**
    -   Revisar `TradeOrderDetails` para asegurar que soporta todos los campos necesarios para órdenes TSL/TP (ej. `stopPrice`, `trailingStopActivationPrice`, `trailingStopCallbackRate`).
    -   Asegurar que `Trade` pueda vincular múltiples `exitOrders` y que `riskRewardAdjustments` pueda registrar los movimientos de SL/TP.
    -   Actualizar `UserConfiguration.realTradingSettings` para incluir cualquier nuevo campo necesario para la gestión de capital diario (ej. `daily_capital_risked_real`).

### Frontend

-   **`PortfolioWidget` o `DashboardView` (`src/ultibot_ui/widgets/` o `src/ultibot_ui/windows/`):**
    -   Modificar la visualización de operaciones abiertas para incluir los niveles de TSL y TP para las operaciones reales.
    -   Actualizar el resumen del portafolio para mostrar el capital disponible para nuevas operaciones reales, considerando los límites de gestión de capital.
    -   Mostrar mensajes claros en la UI si se alcanza el límite de capital diario o si no se pueden abrir nuevas operaciones reales debido a las reglas de gestión de capital.
-   **`NotificationWidget` (`src/ultibot_ui/widgets/notification_widget.py`):**
    -   Asegurar que las nuevas notificaciones de ejecución de TSL/TP reales se muestren correctamente, con su prioridad y detalles relevantes.
-   **`ApiClient` (`src/ultibot_ui/services/api_client.py`):**
    -   Asegurar que el cliente API pueda consumir los datos actualizados del backend sobre el estado de las operaciones y los niveles de TSL/TP.

## Story Progress Notes

### Agent Model Used: Claude 3.5 Sonnet

### Completion Notes List

- Historia 4.4 creada con éxito, incluyendo la historia de usuario, criterios de aceptación, tareas/subtareas y guía técnica detallada.
- Se ha puesto énfasis en la integración de la lógica de gestión de capital y la reutilización de la lógica de TSL/TP del paper trading para operaciones reales.
- Se han considerado las interacciones con Binance API, ConfigService, NotificationService y la actualización de la UI.

### Change Log
- 2025-05-31: Creación inicial de la historia 4.4.
